<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lj.iot.biz.db.smart.mapper.UserGoodsMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.lj.iot.biz.db.smart.entity.UserGoods">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="hotel_id" property="hotelId"/>
        <result column="goods_name" property="goodsName"/>
        <result column="goods_alias" property="goodsAlias"/>
        <result column="quantity" property="quantity"/>
        <result column="state" property="state"/>
        <result column="goods_code" property="goodsCode"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id
        , user_id, goods_name, goods_alias, quantity, state, goods_code
    </sql>

    <update id="cutQuantity">
        update user_goods
        set quantity=quantity - #{value}
        where id = #{id}
          and quantity - #{value} >= 0
    </update>

    <select id="customPage" resultMap="BaseResultMap">
        select * from user_goods
        <where>
            <if test="hotelId!=null">
                AND hotel_id = #{hotelId}
            </if>
            <if test="userId!=null and userId!=''">
                AND user_id = #{userId}
            </if>
            <if test="params.search!=null and params.search!=''">
                AND (
                goods_name LIKE CONCAT(#{params.search},"%")
                or goods_alias LIKE CONCAT(#{params.search},"%")
                )
            </if>
        </where>
        ORDER BY id DESC
    </select>
    <select id="customPageUserDevice" resultType="com.lj.iot.biz.base.vo.SeachDeviceVo">
        SELECT
            p.`images_url`,
            ud.`device_name`,
            ud.`custom_name`,
            h.`hotel_name`,
            ho.`home_name`,
            hf.`floor_name`,
            ud.device_id,
            huc.`mobile`
        FROM
            user_device ud
                LEFT JOIN hotel_floor_home hfh ON hfh.`home_id`=ud.`home_id`
                LEFT JOIN hotel h ON h.`id`=hfh.`hotel_id`
                LEFT JOIN product p ON ud.`product_id`=p.`product_id`
                LEFT JOIN home ho ON ho.`id`=ud.`home_id`
                LEFT JOIN hotel_floor hf ON hf.`id`=hfh.`floor_id`
                LEFT JOIN hotel_user_account huc ON huc.`id`=ud.`user_id`
        <where>
            <if test="params.search != null and params.search != '' ">
                ud.device_id  LIKE CONCAT('%',#{params.search},'%')
            </if>
            <if test="params.search == null or params.search == '' ">
                ud.device_id='XXXXX'
            </if>
        </where>
        GROUP BY ud.`device_id`
    </select>
</mapper>
